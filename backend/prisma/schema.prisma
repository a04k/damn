// Prisma Schema for College Guide App
// Egyptian Science Faculty Structure: Faculty → Department → Program (Specialization)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============ ORGANIZATIONAL STRUCTURE ============
// Egyptian Faculty Structure:
// Faculty of Science
// ├── Mathematics Department
// │   ├── Computer Science Program
// │   ├── Statistics Program
// │   └── Pure Mathematics Program
// ├── Biology Department
// │   ├── Zoology Program
// │   ├── Botany Program
// │   └── Microbiology Program
// └── Chemistry Department
//     ├── Applied Chemistry Program
//     └── Biochemistry Program

model Faculty {
  id          String   @id @default(cuid())
  name        String   @unique
  nameAr      String?  @map("name_ar")  // Arabic name
  code        String   @unique
  description String?  @db.Text
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  departments Department[]
  
  @@map("faculties")
}

model Department {
  id          String   @id @default(cuid())
  name        String
  nameAr      String?  @map("name_ar")
  code        String   @unique
  description String?  @db.Text
  
  facultyId   String   @map("faculty_id")
  faculty     Faculty  @relation(fields: [facultyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // A department has multiple specialization programs
  programs    Program[]
  // Courses belong to departments
  courses     Course[]
  // Professors belong to a department
  professors  User[]   @relation("ProfessorDepartment")
  
  @@unique([facultyId, name])
  @@map("departments")
}

model Program {
  id           String   @id @default(cuid())
  name         String      // e.g., "Computer Science", "Zoology", "Statistics"
  nameAr       String?     @map("name_ar")
  code         String   @unique
  description  String?  @db.Text
  creditHours  Int      @default(132) @map("credit_hours")
  
  departmentId String   @map("department_id")
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  // Students enrolled in this program
  students     User[]   @relation("StudentProgram")
  // Professors who can teach in this program
  programInstructors ProgramInstructor[]
  // Courses specific to this program
  courses      Course[]
  
  @@unique([departmentId, name])
  @@map("programs")
}

// Many-to-many: Professors can teach in multiple programs
model ProgramInstructor {
  id          Int      @id @default(autoincrement())
  assignedAt  DateTime @default(now()) @map("assigned_at")
  
  professorId String   @map("professor_id")
  professor   User     @relation(fields: [professorId], references: [id], onDelete: Cascade)
  programId   String   @map("program_id")
  program     Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  
  @@unique([professorId, programId])
  @@map("program_instructors")
}

// ============ USER MANAGEMENT ============

model User {
  id                    String   @id @default(cuid())
  email                 String   @unique
  password              String
  name                  String
  nameAr                String?  @map("name_ar")
  avatar                String?
  phone                 String?
  
  role                  UserRole @default(STUDENT)
  
  // Student-specific
  studentId             String?  @unique @map("student_id")
  gpa                   Float?
  level                 Int?     // Academic year (1, 2, 3, 4)
  
  // Student belongs to ONE program (specialization)
  programId             String?  @map("program_id")
  program               Program? @relation("StudentProgram", fields: [programId], references: [id], onDelete: SetNull)
  
  // Professor belongs to ONE department but can teach in multiple programs
  departmentId          String?  @map("department_id")
  department            Department? @relation("ProfessorDepartment", fields: [departmentId], references: [id], onDelete: SetNull)
  
  // Account status
  isVerified            Boolean  @default(false) @map("is_verified")
  isOnboardingComplete  Boolean  @default(false) @map("is_onboarding_complete")
  isActive              Boolean  @default(true) @map("is_active")
  
  fcmToken              String?  @map("fcm_token")
  
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  lastLoginAt           DateTime? @map("last_login_at")
  
  // Relations
  enrollments           Enrollment[]
  teachingCourses       CourseInstructor[]
  programsTeaching      ProgramInstructor[]
  tasksCreated          Task[]           @relation("TaskCreator")
  taskSubmissions       TaskSubmission[]
  announcementsCreated  Announcement[]
  notifications         Notification[]
  scheduleEvents        ScheduleEvent[]
  contentCreated        CourseContent[]
  verificationCodes     VerificationCode[]
  
  @@index([programId])
  @@index([departmentId])
  @@map("users")
}

enum UserRole {
  STUDENT
  PROFESSOR
  ADMIN
}

// ============ VERIFICATION ============

model VerificationCode {
  id        Int      @id @default(autoincrement())
  code      String
  type      VerificationType
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([code])
  @@map("verification_codes")
}

enum VerificationType {
  REGISTRATION
  PASSWORD_RESET
  EMAIL_CHANGE
}

// ============ COURSES ============

model Course {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  nameAr      String?  @map("name_ar")
  description String?  @db.Text
  category    CourseCategory @default(GENERAL)
  creditHours Int      @default(3) @map("credit_hours")
  
  semester    String?
  academicYear String? @map("academic_year")
  isActive    Boolean  @default(true) @map("is_active")
  
  // Course belongs to a department
  departmentId String? @map("department_id")
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  
  // Course can be specific to a program (optional)
  programId    String? @map("program_id")
  program      Program? @relation(fields: [programId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  instructors     CourseInstructor[]
  enrollments     Enrollment[]
  content         CourseContent[]
  tasks           Task[]
  announcements   Announcement[]
  scheduleSlots   CourseSchedule[]
  
  @@index([departmentId])
  @@index([programId])
  @@map("courses")
}

enum CourseCategory {
  COMP
  MATH
  CHEM
  PHYS
  BIO
  GENERAL
  ELECTIVE
}

// ============ COURSE RELATIONS ============

model CourseInstructor {
  id          Int      @id @default(autoincrement())
  isPrimary   Boolean  @default(false) @map("is_primary")
  assignedAt  DateTime @default(now()) @map("assigned_at")
  
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId    String   @map("course_id")
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, courseId])
  @@map("course_instructors")
}

model Enrollment {
  id           Int              @id @default(autoincrement())
  status       EnrollmentStatus @default(ENROLLED)
  enrolledAt   DateTime         @default(now()) @map("enrolled_at")
  completedAt  DateTime?        @map("completed_at")
  grade        String?
  gradePoints  Float?           @map("grade_points")
  
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId     String   @map("course_id")
  course       Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@map("enrollments")
}

enum EnrollmentStatus {
  ENROLLED
  COMPLETED
  DROPPED
  WITHDRAWN
  FAILED
}

// ============ COURSE CONTENT ============

model CourseContent {
  id          String      @id @default(cuid())
  title       String
  description String?     @db.Text
  contentType ContentType
  fileUrl     String?     @map("file_url")
  attachments Json?       
  weekNumber  Int?        @map("week_number")
  orderIndex  Int         @default(0) @map("order_index")
  isPublished Boolean     @default(true) @map("is_published")
  
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  
  courseId    String      @map("course_id")
  course      Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdById String      @map("created_by_id")
  createdBy   User        @relation(fields: [createdById], references: [id])
  
  @@index([courseId, weekNumber])
  @@map("course_content")
}

enum ContentType {
  LECTURE
  MATERIAL
  VIDEO
  DOCUMENT
  LINK
}

model CourseSchedule {
  id        Int      @id @default(autoincrement())
  dayOfWeek DayOfWeek
  startTime String   @map("start_time")
  endTime   String   @map("end_time")
  location  String?
  room      String?
  
  courseId  String   @map("course_id")
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@map("course_schedules")
}

enum DayOfWeek {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

// ============ TASKS & ASSIGNMENTS ============

model Task {
  id           String       @id @default(cuid())
  title        String
  description  String?      @db.Text
  taskType     TaskType     @default(ASSIGNMENT) @map("task_type")
  priority     TaskPriority @default(MEDIUM)
  
  dueDate      DateTime?    @map("due_date")
  startDate    DateTime?    @map("start_date")
  maxPoints    Int          @default(100) @map("max_points")
  attachments  Json?        
  questions    Json?
  settings     Json?
  published    Boolean      @default(true)
  
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  
  status       String       @default("PENDING")
  completedAt  DateTime?    @map("completed_at")
  
  courseId     String?      @map("course_id")
  course       Course?      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdById  String       @map("created_by_id")
  createdBy    User         @relation("TaskCreator", fields: [createdById], references: [id])
  submissions  TaskSubmission[]
  
  @@index([dueDate])
  @@index([courseId])
  @@index([createdById])
  @@index([status])
  @@index([createdById, status])
  @@map("tasks")
}

model TaskSubmission {
  id           String           @id @default(cuid())
  status       SubmissionStatus @default(PENDING)
  submittedAt  DateTime?        @map("submitted_at")
  fileUrl      String?          @map("file_url")
  notes        String?          @db.Text
  
  answers      Json?            // For exam answers
  startedAt    DateTime?        @map("started_at") // For timed exams
  snapshots    Json?            // For proctoring logs
  
  points       Float?
  grade        String?
  feedback     String?          @db.Text
  gradedAt     DateTime?        @map("graded_at")
  
  taskId       String       @map("task_id")
  task         Task         @relation(fields: [taskId], references: [id], onDelete: Cascade)
  studentId    String       @map("student_id")
  student      User         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@unique([taskId, studentId])
  @@map("task_submissions")
}

enum TaskType {
  ASSIGNMENT
  EXAM
  QUIZ
  PROJECT
  LAB
  PERSONAL
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
  LATE
  GRADED
  RETURNED
}

// ============ ANNOUNCEMENTS ============

model Announcement {
  id             String           @id @default(cuid())
  title          String
  message        String           @db.Text
  type           AnnouncementType @default(GENERAL)
  isPinned       Boolean          @default(false) @map("is_pinned")
  
  createdAt      DateTime         @default(now()) @map("created_at")
  expiresAt      DateTime?        @map("expires_at")
  
  courseId       String?          @map("course_id")
  course         Course?          @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdById    String           @map("created_by_id")
  createdBy      User             @relation(fields: [createdById], references: [id])
  
  @@index([createdAt])
  @@map("announcements")
}

enum AnnouncementType {
  GENERAL
  ASSIGNMENT
  EXAM
  LECTURE
  URGENT
  MAINTENANCE
}

// ============ NOTIFICATIONS ============

model Notification {
  id            String           @id @default(cuid())
  title         String
  message       String           @db.Text
  type          NotificationType @default(GENERAL)
  
  referenceType ReferenceType?   @map("reference_type")
  referenceId   String?          @map("reference_id")
  
  isRead        Boolean          @default(false) @map("is_read")
  isPushed      Boolean          @default(false) @map("is_pushed")
  
  createdAt     DateTime         @default(now()) @map("created_at")
  readAt        DateTime?        @map("read_at")
  
  userId        String           @map("user_id")
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  GENERAL
  ANNOUNCEMENT
  ASSIGNMENT
  EXAM
  GRADE
  REMINDER
  SYSTEM
}

enum ReferenceType {
  ANNOUNCEMENT
  TASK
  COURSE
  CONTENT
}

// ============ SCHEDULE EVENTS ============

model ScheduleEvent {
  id          String    @id @default(cuid())
  title       String
  description String?   @db.Text
  eventType   EventType @default(PERSONAL)
  
  startTime   DateTime  @map("start_time")
  endTime     DateTime  @map("end_time")
  isAllDay    Boolean   @default(false) @map("is_all_day")
  
  location    String?
  
  isRecurring Boolean   @default(false) @map("is_recurring")
  recurrenceRule String? @map("recurrence_rule")
  
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([startTime])
  @@index([userId])
  @@map("schedule_events")
}

enum EventType {
  LECTURE
  EXAM
  ASSIGNMENT_DUE
  MEETING
  OFFICE_HOURS
  PERSONAL
}
